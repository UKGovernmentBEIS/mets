package uk.gov.pmrv.api.migration.emp.ukets.emissionsreductionclaim;

import static uk.gov.pmrv.api.migration.emp.common.MigrationEmissionsMonitoringPlanHelper.constructSectionQuery;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.function.Function;
import java.util.stream.Collectors;

import org.springframework.boot.actuate.autoconfigure.endpoint.condition.ConditionalOnAvailableEndpoint;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.stereotype.Service;

import lombok.RequiredArgsConstructor;
import uk.gov.pmrv.api.account.domain.Account;
import uk.gov.pmrv.api.emissionsmonitoringplan.ukets.domain.emissionsreductionclaim.EmpEmissionsReductionClaim;
import uk.gov.pmrv.api.migration.MigrationEndpoint;
import uk.gov.pmrv.api.migration.emp.ukets.EmissionsMonitoringPlanMigrationContainer;
import uk.gov.pmrv.api.migration.emp.ukets.EmissionsMonitoringPlanSectionMigrationService;

@Service
@RequiredArgsConstructor
@ConditionalOnAvailableEndpoint(endpoint = MigrationEndpoint.class)
public class EmpEmissionsReductionClaimSectionMigrationService implements EmissionsMonitoringPlanSectionMigrationService<EmpEmissionsReductionClaim> {

	private final JdbcTemplate migrationJdbcTemplate;

    private static final String QUERY_BASE  =
        "select e.fldEmitterID, saf.fldEmitterDisplayID, saf.purchase_delivery_title, saf.purchase_delivery_reference, saf.purchase_delivery_description, saf.purchase_delivery_post, saf.purchase_delivery_location, saf.purchase_delivery_system,\r\n"
        + "saf.sustainability_title, saf.sustainability_reference, saf.sustainability_description, saf.sustainability_post, saf.sustainability_location, saf.sustainability_system,\r\n"
        + "saf.avoidance_title, saf.avoidance_reference, saf.avoidance_description, saf.avoidance_post, saf.avoidance_location, saf.avoidance_system from (values\r\n"
        + "(3, 'SAF Purchase and Delivery', 'E201', 'All SAF purchased will be documented by Product Transfer Documents (PTD) provided by our fuel supplier. The PTD will detail the mass of the SAF supplied, date of purchase and delivery, as well as the fuel supplier, SAF type and corresponding Proof of Sustainability certificate number for the production facility. The information in each PTD will be transferred to the SAF management database, where the mass of SAF purchased and delivered to British Airways will be accounted per calendar year.\r\n"
        + "Where the amount of SAF is specified in volume, this will be converted to mass (tonnes) using the density figure provided by the fuel supplier.  The mass of SAF purchased in the year will be cross checked via fuel supplier PTDs and any discrepancies investigated and resolved.\r\n"
        + "The PTD documents will be stored electronically for audit purposes by the verifier. The final figure will be used in the ERC and will be included in the annual emissions report when compiled in the following year.', 'IAG Sustainability', 'IAG Sustainability LAN', 'SAF management database', 'SAF Sustainability Criteria', 'E202', 'British Airways will obtain the necessary sustainability evidence for all SAF purchased and delivered, which is to be included in any Emissions Reduction Claim. British Airways will obtain relevant Proof of Sustainability (PoS) certificates, RTFO Operating System (ROS) screen shots or equivalent for all SAF purchased from the fuel supplier. Where the certificate for the corresponding batch of SAF is not available at the time of the provision of the PTD, British Airways will ensure that the certificate is obtained in time for inclusion in the ERC. Where a PoS is not available for a batch of SAF purchased, British Airways will engage with the fuel supplier to obtain a suitable alternative. If no sustainability evidence for a SAF batch can be sourced, the mass of this batch will not be included in any ERC.\r\n"
        + "All PoS documents or equivalent will be checked to ensure that they contain the necessary information to confirm the RTFO sustainability criteria have been met. All PoS documents or equivalent will be stored electronically.', 'IAG Sustainability', 'IAG Sustainability LAN', 'SAF management database', 'SAF Avoidance of Double Counting', 'E203', 'British Airways have obligations under both the UK ETS and EU ETS, and there is the potential to make ERCs under both schemes. When details of the batch of SAF are entered into the SAF management database, the batch will be flagged as to which scheme the Emissions Reduction is to be claimed under, ensuring that any batch is not included in ERCs for both schemes or any other similar regulatory scheme. If any SAF is sold on to a third party, the SAF management database will be updated to show that the sold SAF is no longer to be included in any ERC and will be excluded from the SAF usage calculation for the scheme year. A copy of the sale PTD that was issued for the SAF that was sold will also be stored electronically.', 'IAG Sustainability', 'IAG Sustainability LAN', 'SAF management database'),\r\n"
        + "(83, 'SAF Purchase and Delivery', 'ETS SAF 1', 'All SAF purchased will be documented by the Product Transfer Documents (PTD) provided by our fuel supplier. The PTD details the mass of the SAF supplied, date of purchase and delivery, as well as the fuel supplier, SAF type and feedstock information. The corresponding ISCC Proof of Sustainability certification is evidenced by the the PTD or suitable alternative where the POS is not included. The information in the PTD is transferred to the ''VAA central SAF registry'' Excel-based database, where the mass of SAF purchased and delivered to Virgin Atlantic is accounted for. This registry is password protected, with restricted user access, and is audited annually by an independent third-party. Where the amount of SAF is specified in volume, this will be converted to mass (tonnes) using the density figure provided by the fuel supplier. The mass of SAF purchased in the year will be cross checked via fuel supplier invoices and any discrepancies investigated and resolved. The PTD documents will be stored electronically with a document control system in place, for audit purposes by the verifier. The final figure will be used in the ERC and will be included in the annual emissions report when compiled in the following year.', 'Fuel Department, Sustainability team', 'VAA central SAF registry'' folder on private Teams/SharePoint site, stored in the cloud', 'VAA central SAF registry'', Excel file', 'SAF Sustainability Criteria', 'ETS SAF 2', 'Virgin Atlantic will obtain the necessary sustainability evidence for all SAF purchased and delivered, which is to be included in any Emissions Reduction Claim. Virgin Atlantic will endeavour to obtain ISCC EU Proof of Sustainability (PoS) certificates or equivalent for all SAF purchased from the fuel supplier. Where the certificate for the corresponding batch of SAF is not available at the time of the provision of the PTD, Virgin Atlantic will ensure that the certificate is obtained in time for inclusion in the ERC. Where a PoS is not available for a batch of SAF purchased, Virgin Atlantic will engage the fuel supplier/producer to obtain a suitable alternative, such as separate document evidencing that the SAF is ISCC (or similar) certified, e.g. a Location Agreement document. If no sustainability evidence for a SAF batch can be sourced, the mass of this batch will not be included in any ERC. All PoS documents or equivalent will be checked to ensure that they contain the necessary information to confirm the RTFO sustainability criteria have been met. All PoS documents or equivalent will be stored electronically with a document control system in place.', 'Fuel Department, Sustainability team', 'VAA central SAF registry'' folder on private Teams/SharePoint site, stored in the cloud', 'VAA central SAF registry'', Excel file', 'SAF Avoidance of double counting', 'ETS SAF 3', 'Virgin Atlantic have obligations under both the UK ETS and EU ETS, and there is the potential to make ERCs under both schemes. When details of the batch of SAF are entered into the VAA central SAF registry, if applicable, the batch will be flagged as to which scheme the Emissions Reduction is to be claimed under, ensuring that any batch is not included in ERCs for both schemes or any other similar regulatory scheme. If any volume from a batch of SAF is sold on to a third party, the VAA central SAF registry will be updated to show that this volume is no longer to be included in any ERC and will be excluded from the SAF usage calculation for the scheme year. A copy of the sale document of the batch will also be stored electronically.', 'Fuel Department, Sustainability team', 'VAA central SAF registry'' folder on private Teams/SharePoint site, stored in the cloud', 'VAA central SAF registry'', Excel file'),\r\n"
        + "(6763, 'SAF Purchase and Delivery', 'SAFProcurementUKETS', 'All SAF purchased will be documented through Product Transfer Documents (PTD) which are provided by the fuel supplier. The PTD documents key information, including delivery location, mass and source of the SAF supplied, intended DHL Customer airline and suitability criteria of the SAF supplied. Delivery of SAF is ensured by using invoices which re-affirm what was stated in the PTD documents, as well as confirmation of delivery date. Any mismatches are investigated and resolved.\r\n"
        + "There is a history / log in the fuel invoice which documents key stages of the fuel procurement. Fuel is shipped in Metres Cubed and is converted to KG using the density figures provided by the fuel producer. PTD and invoice documents are stored electronically in ABIDW and saved for audit purposes. A final figure ERC will be calculated and included within a submission of the annual emissions report.', 'ESG Accounting, Reporting & Controlling', 'DPDHL Global Head Office, Bonn, Germany', 'ABIDW', 'SAF Sustainability Criteria', 'SAFSuitabilityUKETS', 'DHL Air will obtain the sustainability evidence from  PTD documents provided by the producer. SAF will have been registered by the supplier within the RTFO scheme. DHL will encourage suppliers to produce a PoS document, or invoice which proves delivery of the SAF. The PoS wil be checked by the Express Carbon Accounting & Controlling Team before it is included within an ERC to ensure that the document being submitted is correct. These checks will also confirm that the SAF meet the RTFO sustainability criteria. If no supporting documentation can be produced, or the SAF does not meet the criteria, the batch will not be included within an ERC. Documents will be stored electronically.', 'Express Carbon Accounting & Controlling', 'Leipzig, Germany', 'ABIDW', 'SAF Avoidance of Double Counting', 'SAFAssuranceUKETS', 'DHL Air Limited has obligations under both the EU and UK ETS schemes and therefore has the potential to make ERC''s under both schemes. DHL Air Limited is not currently eligible to claim SAF through the EU ETS scheme so currently SAF could not be double counted. DHL will maintain a database of active batches of SAF and note which ERC scheme they will belong to should a claim be made under EU ETS. If a batch of SAF is not used under an ERC or is sold to another third party, such as another DHL partner airline, the database will be updated to reflect that the SAF is no longer eligible to be claimed under DHL Air''s ERC. A copy of this database is saved electronically.', 'Express Carbon Accounting & Controlling', 'Leipzig, Germany', 'ABIDW'),\r\n"
        + "(12487, 'SAF purchase and delivery', 'ETS SAF 1', 'All SAF purchased will be documented by Product Transfer Documents (PTD) provided by our fuel supplier.  Flight crew will contact fuel supplier directly via email and in that request, detail aircraft callsign, ICAO location, date and time of arrival and departure, uplift required in USG and handling agent used. Once SAF is uplifted, crew will keep records of SAF mass in aircraft Flight Log as well as keep a digital copy of SAF receipts on our cloud storage software. This will also be recorded post flight via our operational monitoring software, SD Pro for auditing and verification. For ERC reporting, figures will be cross checked with fuel receipts and any issues investigated and resolved.  The final figure of SAF uplifted will be used in the ERC and will be included in the annual emissions report when compiled for the UK ETS reporting year.', 'Aviation Department Manager', 'Digital data storage, Level 2, 87 Adelaide terrace, East Perth 6004, Western Australia', 'SD Pro', 'SAF Sustainability Criteria', 'ETS SAF 2', 'FMG Air PTY Ltd will obtain the necessary sustainability evidence for all SAF purchased and delivered, which is to be included in any Emissions Reduction Claim.\r\n"
        + "SAF will be verified by fuel supplier in writing and relevant compliance documents and sustainability certificates (ISCC EU Proof of Sustainability (PoS) certificates or equivalent) will be requested by FMG Air PTY Ltd if needed to be included in any ERC. After engagement with fuel supplier and if no sustainability certificates or proof of compliance can be sourced, the mass of SAF will not be included in the ERC. All SAF that is recorded on the ERC will be checked to ensure they contain the necessary information to meet RFTO sustainability criteria. All PoS documents or equivalent will be stored electronically via our digital cloud storage software.', 'Aviation Department Manager', 'Digital data storage, Level 2, 87 Adelaide terrace, East Perth 6004, Western Australia', 'One Drive', 'SAF Avoidance of double counting', 'ETS SAF 3', 'FMG Air currently only have compliance obligations under UK ETS and are not making ERC under any other schemes.  When details of the batch of SAF are entered into the SD Pro Database, the batch will be flagged as  UK ETS to ensure the ERC is not included in any other scheme.\r\n"
        + "FMG Air do not intend to sell on any SAF purchased.  If any batch of SAF is sold on to a third party, the SD Pro database will be updated to show that this batch is no longer  to be include in any ERC and will be excluded from the SAF usage calculation for the scheme year. A copy of the sale documentation of the batch will also be stored electronically.', 'Aviation Department Manager', 'Digital data storage, Level 2, 87 Adelaide terrace, East Perth 6004, Western Australia', 'SD Pro'),\r\n"
        + "(13668, 'SAF Purchase and Delivery', 'ETS SAF 1', 'All SAF purchased will be documented by Product Transfer Documents (PTD) provided by our fuel supplier. The PTD will detail the mass of the SAF supplied, date of purchase and delivery, as well as the fuel supplier, SAF type and corresponding ISCC Proof of Sustainability certificate number. The information in each PTD will be transferred to the ETS Data Repository, where the mass of SAF purchased and delivered to easyJet UK will be accounted per calendar year. Where the amount of SAF is specified in volume, this will be converted to mass (tonnes) using the density figure provided by the fuel supplier. The mass of SAF purchased in the year will be cross checked via fuel supplier invoices and any discrepancies investigated and resolved. The PTD documents will be stored electronically in the ETS Data Repository , for audit purposes by the verifier. The final figure will be used in the ERC and will be included in the annual emissions report when compiled in the following year.', 'ETS Manager', 'easyJet, Hangar 89. London Luton Airport', 'ETS Data Respository', 'SAF Sustainability Criteria', 'ETS SAF 2', 'easyJet UK will obtain the necessary sustainability evidence for all SAF purchased and delivered, which is to be included in any Emissions Reduction Claim. easyJet UK will obtain ISCC EU Proof of Sustainability (PoS) certificates or equivalent for all SAF purchased from the fuel supplier. Where the certificate for the corresponding batch of SAF is not available at the time of the provision of the PTD, easyJet UK will ensure that the certificate is obtained in time for inclusion in the ERC. Where a PoS is not available for a batch of SAF purchased, easyJet UK will engage with the fuel supplier to obtain a suitable alternative. If no sustainability evidence for a SAF batch can be sourced, the mass of this batch will not be included in any ERC. All PoS documents or equivalent will be checked to ensure that they contain the necessary information to confirm the RTFO sustainability criteria have been met. All PoS documents or equivalent will be stored electronically with a document control system in place.', 'ETS Manager', 'easyJet, Hangar 89. London Luton Airport', 'ETS Data Respository', 'SAF Avoidance of double counting', 'ETS SAF 3', 'easyJet UK have obligations under both the UK ETS and EU ETS, and there is the potential to make ERCs under both schemes. When details of the batch of SAF are entered into the ETS Data Repository, the batch will be flagged as to which scheme the Emissions Reduction is to be claimed under, ensuring that any batch is not included in ERCs for both schemes or any other similar regulatory scheme. If any batch of SAF is sold on to a third party, the ETS Data Repository will be updated to show that this batch is no longer to be included in any ERC and will be excluded from the SAF usage calculation for the scheme year. A copy of the sale document of the batch which also be stored electronically.', 'ETS Manager', 'easyJet, Hangar 89. London Luton Airport', 'ETS Data Respository'),\r\n"
        + "(13918, 'SAF Purchase and Delivery', 'ETS SAF 1', 'All SAF purchased will be documented by Product Transfer Documents (PTD) provided by our fuel supplier. The PTD will detail the mass of the SAF supplied, date of purchase and delivery, as well as the fuel supplier, SAF type. The ISCC Certificate is provided by the fuel supplier. The information in each PTD will be transferred to  UK SAF  database, where the mass of SAF purchased and delivered to Cargolux will be accounted per calendar year. Where the amount of SAF is specified in volume, this will be converted to mass (tonnes) using the density figure provided by the fuel supplier.  The mass of SAF purchased in the year will be cross checked via fuel supplier invoices and any discrepancies investigated and resolved. The PTD documents will be stored electronically with a document control system in place, for audit purposes by the verifier. The final figure will be used in the ERC and will be included in  the  annual emissions report when compiled in the following year.', 'Fuel Management Department', 'Cargolux Airlines International S.A., Luxembourg Airport, Sandweiler, 2990', 'SAF UK DATABASE', 'SAF Sustainability Criteria', 'ETS SAF 2', 'Cargolux will obtain the necessary sustainability  evidence for all SAF purchased and delivered, which is to be included in any Emissions Reduction Claim. Cargolux will obtain ISCC certiificates or equivalent for all SAF purchased from the fuel supplier. Where the certificate for the corresponding batch of SAF is not available at the time of the provision of the PTD, Cargolux will ensure that the certificate is obtained in time for inclusion in the ERC. If no sustainability evidence  for a SAF batch can be sourced, the mass of this batch will not be included in any ERC. All PoS documents or equivalent will be checked to ensure that they contain the necessary information to confirm the RTFO sustainability criteria have been met.  All PoS documents or equivalent will be stored electronically with a document control system in place.', 'Fuel Management', 'Cargolux Airlines International S.A., Luxembourg Airport, Sandweiler, 2990', 'SAF UK DATABASE', 'SAF Avoidance of double counting', 'ETS SAF 3', 'Cargolux have obligations under both the UK ETS and EU ETS, and there is the potential to make ERCs under both schemes. When details of the batch of SAF are entered  into the UK SAF Database, the batch will be flagged as to which scheme the Emissions Reduction is to be claimed under, ensuring that any batch is not included in ERCs for both schemes or any other similar regulatory scheme. If any batch of SAF is sold on to a third party, the UK SAF Database will be updated to show that this batch is no longer to be included in any ERC and will be excluded from the SAF usage calculation for the scheme year. A copy of the sale document of the batch which also be stored electronically', 'Fuel Management', 'Cargolux Airlines International S.A., Luxembourg Airport, Sandweiler, 2990', 'SAF UK Database'),\r\n"
        + "(13926, 'SAF Purchase and Delivery', 'ETS SAF 1', 'All SAF purchased will be documented by Sustainability Statements provided by our fuel supplier. The Sustainability Statements will detail the mass of the SAF supplied, date of purchase and delivery, as well as the fuel supplier, SAF type and corresponding ISCC Proof of Sustainability certificate number. The information in each Sustainability Statements will be transferred by Vueling''s Sustainability Department and stored in the VY SAF DB, where the mass of SAF purchased will be accounted per calendar year. Where the amount of SAF is specified in volume, this will be converted to mass (tonnes) using the density figure provided by the fuel supplier. The mass of SAF purchased in the year will be cross checked via fuel supplier invoices and any discrepancies investigated and resolved. The Sustainability Statements documents will be stored electronically with a document control system in place, for audit purposes by the verifier. The final figure will be used in the ERC and will be included in  the  annual emissions report when compiled in the following year.', 'ETS Manager', 'Vueling internal records', 'VY SAF DB', 'SAF Sustainability Criteria', 'ETS SAF 2', 'The ETS Manager will obtain the necessary sustainability evidence for all SAF purchased and delivered, which is to be included in any Emissions Reduction Claim. The ETS Manager will obtain ISCC EU Proof of Sustainability (PoS) certificates or equivalent for all SAF purchased from the fuel supplier. Where the certificate for the corresponding batch of SAF is not available at the time of the provision, the ETS Manager will ensure that the certificate is obtained in time for inclusion in the ERC. Where a PoS is not available for a batch of SAF purchased, the ETS Manager will engage with the fuel supplier to obtain a suitable alternative. If no sustainability evidence  for a SAF batch can be sourced, the mass of this batch will not be included in any ERC. All PoS documents or equivalent will be checked to ensure that they contain the necessary information to confirm the RTFO sustainability criteria have been met.B15  All PoS documents or equivalent will be stored electronically with a document control system in place.', 'ETS Manager', 'Vueling internal records', 'VY SAF DB', 'SAF Avoidance of double counting', 'ETS SAF 3', 'Vueling Airlines have obligations under both the UK ETS and EU ETS, and there is the potential to make ERCs under both schemes. When details of the batch of SAF are entered  into the VY SAF DB, the batch will be flagged as to which scheme the Emissions Reduction is to be claimed under, ensuring that any batch is not included in ERCs for both schemes or any other similar regulatory scheme. Vueling does not sell any batch of SAF to any third party provider. This condition will be yearly confirmed by IAG GBS and Vueling Sustainability Director. In case any batch of SAF is sold to a third party, the VY SAF DB will be updated to show that this batch is no longer to be included in any ERC and will be excluded from the SAF usage calculation for the scheme year. A copy of the sale document of the batch which also be stored electronically.', 'ETS Manager', 'Vueling internal records', 'VY SAF DB'),\r\n"
        + "(13946, 'SAF Purchase and Delivery', 'TL.80.004|Emission Reduction Claim', 'All documents related to the purchase of SAF are provided by our fuel supplier. The relevant documents include details such as the mass of the SAF supplied, date of purchase and delivery,  fuel supplier, and corresponding ISCC Proof of Sustainability certificate number. The SAF type and corresponding evidence of the relevant SAF Sustainability Criteria will be provided by the supplier. The information regarding SAF purchases will be transferred to THY via e-mail, where the mass of SAF purchased and delivered to THY is accounted for. Where the amount of SAF is specified in volume, this will be converted to mass (tonnes) using the density figure provided by the fuel supplier. The mass of SAF purchased will be cross-checked via fuel supplier invoices and any discrepancies investigated and resolved. The documents will be stored within a dedicated ETS folder on our server for audit purposes by the verifier. This folder is only accessible to persons involved with ETS monitoring and reporting.\r\n"
        + "Records of the purchase of Eligible SAF and delivery records are used to calculate the corresponding amount of SAF to make an emission reduction claim (ERC). Only the SAF amount purchased in the scheme year or the three months before the scheme year that our emission reduction claim relates to and delivered before the reporting deadline of 31 March in the year following that scheme year will be considered for claiming emissions reductions. The final ERC figure will be included in the annual emissions report when compiled in the following year.', 'Fuel Management Department, Corporate Sustainability Management Department', 'Turkish Airlines Incorporation,  Ataturk Airport, Yesilkoy, Istanbul, 34149', 'Intranet, DDMS', 'SAF Sustainability Criteria', 'TL.80.004|Emission Reduction Claim', 'THY will obtain the necessary sustainability evidence for all SAF purchased and delivered, which is to be included in any Emissions Reduction Claim. THY will obtain evidence of the relevant SAF Sustainability Criteria certificates or equivalents for all SAF purchased from the supplier. Where the certificate for the corresponding SAF is not available at the time of the provision of the document, THY will ensure that the certificate is obtained in time for inclusion in the ERC. Where evidence of the SAF Sustainability Criteria is not available for the SAF purchased, THY will engage with the supplier to obtain a suitable alternative. If no sustainability evidence for the SAF can be sourced, the mass of this batch will not be included in any ERC. All evidence of the SAF Sustainability Criteria documents or equivalent will be checked to ensure that they contain the necessary information to confirm the RFTO sustainability criteria have been met. All the documents or equivalent will be stored within a dedicated ETS folder on our server, for audit purposes by the verifier. This folder is only accessible to persons involved with ETS monitoring and reporting.', 'Fuel Management Department, Corporate Sustainability Management Department', 'Turkish Airlines Incorporation,  Ataturk Airport, Yesilkoy, Istanbul, 34149', 'Intranet, DDMS', 'SAF Avoidance of double counting', 'TL.80.004|Emission Reduction Claim', 'THY has obligations under both the UK ETS, EU ETS, and CORSIA and there is the potential to make emission reduction claims under these schemes. When eligible SAF that it has purchased, used and decided to make an emission reduction claim, the usage and corresponding amount will be identified as to which scheme the Emissions Reduction is to be claimed under.  To ensure that there would be no double-claiming on the dedicated SAF usage for the schemes or any other similar regulatory scheme, we keep track of dedicated amount of SAF used from which batch, match this amount with the purchase records, and mark this amount of SAF if it is planned to be claimed under any scheme. If any amount of SAF is sold to a third party, the corresponding amount of SAF is no longer to be included in any ERC and will be excluded from the SAF usage calculation for the scheme year. All the copies of sale documents or equivalent will be stored within a dedicated ETS folder on our server, for audit purposes by the verifier. This folder is only accessible to persons involved with ETS monitoring and reporting.', 'Corporate Sustainability Management Department, Fuel Management Department', 'Turkish Airlines Incorporation,  Ataturk Airport, Yesilkoy, Istanbul, 34149', 'Intranet, DDMS'),\r\n"
        + "(13948, 'SAF Purchase and Delivery', 'ETS SAF 1', 'All SAF purchased will be documented by Product Transfer Documents (PTD) provided by our fuel supplier. The PTD will detail the mass of the SAF supplied, date of purchase and delivery, as well as the fuel supplier, SAF type and corresponding ISCC Proof of Sustainability certificate number. The information in each PTD will be transferred to SkyOps, ETS declaration follow-up sheet and Good Receipt follow-up sheet , where the mass of SAF purchased and delivered to  each ATI aircrat will be accounted per calendar year. Where the amount of SAF is specified in volume, this will be converted to mass (tonnes) using the density figure provided by the fuel supplier or 0,8 default density.  The mass of SAF purchased in the year will be cross checked via fuel supplier invoices and any discrepancies investigated and resolved. The PTD documents will be stored electronically with a document control system in place, for audit purposes by the verifier. The final figure will be used in the ERC and will be included in  the  annual emissions report when compiled in the following year.', 'OTDAV', 'Head Office, Colomiers, 31770', 'SkyOps, AIRBUS DRIVE (Google sheet), AIRBUS Secured Network Storage (GRfuels.xls), SAP', 'SAF Sustainability Criteria', 'ETS SAF 2', 'ATI will obtain the necessary sustainability  evidence for all SAF purchased and delivered, which is to be included in any Emissions Reduction Claim. ATI will obtain ISCC EU Proof of Sustainability (PoS) certificates or equivalent for all SAF purchased from the fuel supplier. Where the certificate for the corresponding batch of SAF is not available at the time of the provision of the PTD, ATI will ensure that the certificate is obtained in time for inclusion in the ERC. Where a PoS is not available for a batch of SAF purchased, ATI will engage with the fuel supplier to obtain a suitable alternative. If no sustainability evidence  for a SAF batch can be sourced, the mass of this batch will not be included in any ERC. All PoS documents or equivalent will be checked to ensure that they contain the necessary information to confirm the RTFO sustainability criteria have been met.B15  All PoS documents or equivalent will be stored electronically with a document control system in place.', 'OTDAV', 'Head Office, Colomiers, 31770', 'AIRBUS DRIVE', 'SAF Avoidance of double counting', 'ETS SAF 3', 'ATI have obligations under both the UK ETS and EU ETS, and there is the potential to make ERCs under both schemes. When details of the batch of SAF are entered  into the ATI follow-up databases (in particular GRfuels.xls and SAP), the batch will be flagged as to which scheme the Emissions Reduction is to be claimed under, ensuring that any batch is not included in ERCs for both schemes or any other similar regulatory scheme. The SAF bought by ATI is stored in dedicated tanks for subsequent uplift in Beluga aircraft.', 'OTDAV', 'Head Office, Colomiers, 31770', 'AIRBUS Secured Network Storage (GRfuels.xls), SAP'),\r\n"
        + "(14014, 'ETS CORSIA Reporting', 'ENV-PROC-0001_Version5', 'All SAF purchased will be documented by Product Transfer Documents (PTD) provided by our fuel supplier. The PTD will detail the mass of the SAF supplied, date of purchase and delivery, as well as the fuel supplier, SAF type and corresponding ISCC Proof of Sustainability certificate number. The information in each PTD will be transferred to our local OneDrive database, where the mass of SAF purchased and delivered to Societe Air France will be accounted per calendar year. Where the amount of SAF is specified in volume, this will be converted to mass (tonnes) using the density figure provided by the fuel supplier.  The mass of SAF purchased in the year will be cross checked via fuel supplier invoices and any discrepancies investigated and resolved. Our verifier gets all information collected in our OneDrive database for verification purposes. The PTD documents will be stored electronically with a document control system in place, for audit purposes by the verifier. The final figure will be used in the ERC and will be included in the annual emissions report when compiled in the following year.', 'ST.VE (Sustainability Office) / DA.ZP (Fuel procurement)', 'Air France''s mainframe in Toulouse', 'OneDrive', 'ETS CORSIA Reporting', 'ENV-PROC-0001_Version5', 'Societe Air France will obtain the necessary sustainability  evidence for all SAF purchased and delivered, which is to be included in any Emissions Reduction Claim. Societe Air France will obtain ISCC EU Proof of Sustainability (PoS) certificates or equivalent for all SAF purchased from the fuel supplier. Where the certificate for the corresponding batch of SAF is not available at the time of the provision of the PTD, Societe Air France will ensure that the certificate is obtained in time for inclusion in the ERC. Where a PoS is not available for a batch of SAF purchased, Societe Air France will engage with the fuel supplier to obtain a suitable alternative. If no sustainability evidence for a SAF batch can be sourced, the mass of this batch will not be included in any ERC. All PoS documents or equivalent will be checked to ensure that they contain the necessary information to confirm the RTFO sustainability criteria have been met.  All PoS documents or equivalent will be stored electronically in our OneDrive database.', 'ST.VE (Sustainability Office) / DA.ZP (Fuel procurement)', 'Air France''s mainframe in Toulouse', 'OneDrive', 'ETS CORSIA Reporting', 'ENV-PROC-0001_Version5', 'Societe Air France have obligations under both the UK ETS and EU ETS, and there is the potential to make ERCs under both schemes. When details of the batch of SAF are entered into the OneDrive Database, the batch will be flagged as to which scheme the Emissions Reduction is to be claimed under, ensuring that any batch is not included in ERCs for both schemes or any other similar regulatory scheme. We are not selling any batch of SAF to third parties at this stage however Air France is in charge of fuel procurement for all Air France group companies. Thus, the Air France fuel purchasing teams carry out fuel procurement on behalf of:\r\n"
        + "> Air France (Unique Identifier: 227)\r\n"
        + "> Transavia (Unique Identifier: 32673)\r\n"
        + "Air France Fuel Department collects all the data and documentation about all SAF incorporation and this data is also used by Transavia France Sustainability offices for data in their UK ETS reporting. We are clearly distinguishing 2 types of SAF incorporation in our process.\r\n"
        + "1. French Mandate to incorporate SAF on French airports (not claimed in the UK ETS report)\r\n"
        + "2. Voluntary SAF incorporation:\r\n"
        + "This SAF consumption corresponds to an incorporation on top of of the compliance with the regulations of a member state corresponding to voluntary purchases. \r\n"
        + "These voluntary SAF purchases by the Air France Group corresponds to two types of needs:\r\n"
        + "- Low volumes for a specific and identified flight (the delivery of SAF is made to a specific airport for an identified flight).\r\n"
        + "No allocation key is used, the volumes are purchased specifically for Air France or Transavia France and are allocated to the corresponding airline and this is recorded in the OneDrive database. Low volume SAF allocated for Transavia France cannot therefore be used in the ERC for Air France.\r\n"
        + "- Larger volumes purchases in batches:\r\n"
        + "The allocation key for these volumes is 100% for Air France: meaning that Transavia France can''t claim for any of these voluntary batch purchases made by Air France.', 'ST.VE (Sustainability Office) / DA.ZP (Fuel procurement)', 'Air France''s mainframe in Toulouse', 'OneDrive'),\r\n"
        + "(14245, 'SAF Purchase and Delivery', 'ETS SAF - 001', 'All SAF purchased will be documented by an invoice provided by our local airport fuel supplier. The invoice will detail date of purchase and delivery, aircraft in which the fuel was delivered, airport of delivery, blended volume, and batch number or similar identifier in order to tie the purchase back to a parent Product Transfer Document (PTD) or Proof of Sustainability (PoS) provided by the SAF producer to our fuel supplier. The PTD or PoS will detail the total mass and volume of the neat and blended SAF supplied to the fuel supplier, SAF production process and type, trader certificate number, as well as the fuel producer.\r\n"
        + "The information on each invoice and PTD or PoS will be transferred into a database maintained by our Flight Service provider, where the mass of SAF purchased and delivered to UnitedHealth Services, Inc. will be accounted per calendar year. Where the amount of SAF is specified in blended volume, this will be converted to blended mass using the density figure provided on the PTD or PoS and into a unblended (neat) mass (in tonnes) using the mass-based blend calculated from the PTD or PoS. The invoice and PTD or PoS documents will be stored electronically with a document control system in place, for audit purposes by the verifier. The final figure will be used in the ERC and will be included in the annual emissions report when compiled in the following year.', 'Aviation Department & Flight Service Provider', '513 Eaton Street St., St. Paul, MN 55107', 'ETS SAF Recording System', 'SAF Sustainability Criteria', 'ETS SAF - 002', 'UnitedHealth Services, Inc. will obtain the necessary sustainability evidence for all SAF purchased and delivered, which is to be included in any Emissions Reduction Claim. UnitedHealth Services, Inc. will obtain ISCC EU Proof of Sustainability (PoS) certificates or equivalent for all SAF to be claimed. Where the certificate for the corresponding batch of SAF is not available at the time of the provision of the ISCC PoS certificate, UnitedHealth Services, Inc. will ensure that the certificate is obtained in time for inclusion in the ERC. Where a PoS certificate is not available for a batch of SAF purchased, UnitedHealth Services, Inc. will engage with its fuel supplier to obtain a suitable alternative. If no sustainability evidence for a SAF batch can be sourced, the mass of this batch will not be included in any ERC. All PoS documents or equivalent will be checked to ensure that they contain the necessary information to confirm the RTFO sustainability criteria have been met. All PoS documents or equivalent will be stored electronically with a document control system in place.', 'Aviation Department & Flight Service Provider', '513 Eaton Street St., St. Paul, MN 55107', 'ETS SAF Recording System', 'SAF Avoidance of Double-Counting', 'ETS SAF - 003', 'UnitedHealth Services, Inc. only has obligations under the UK ETS but in the future may have obligations under additional schemes such as the EU ETS, and there is the potential to make ERCs under both schemes. When details of the batch of SAF are entered into the ETS SAF Recording System Database, the batch will be flagged as to which scheme the Emissions Reduction is to be claimed under, ensuring that any batch is not included in ERCs for both schemes or any other similar regulatory scheme. If any batch of SAF is sold on to a third party, the ETS SAF Recording System Database will be updated to show that this batch is no longer to be included in any ERC and will be excluded from the SAF usage calculation for the scheme year. A copy of the sale document of the batch which also be stored electronically.', 'Aviation Department & Flight Service Provider', '513 Eaton Street St., St. Paul, MN 55107', 'ETS SAF Recording System')\r\n"
        + ") saf (fldEmitterDisplayID, purchase_delivery_title, purchase_delivery_reference, purchase_delivery_description, purchase_delivery_post, purchase_delivery_location, purchase_delivery_system,\r\n"
        + "sustainability_title, sustainability_reference, sustainability_description, sustainability_post, sustainability_location, sustainability_system,\r\n"
        + "avoidance_title, avoidance_reference, avoidance_description, avoidance_post, avoidance_location, avoidance_system)\r\n"
        + "join tblEmitter e on e.fldEmitterDisplayID = saf.fldEmitterDisplayID\r\n"
        ;
    
    @Override
    public void populateSection(Map<String, Account> accountsToMigrate, 
    		Map<Long, EmissionsMonitoringPlanMigrationContainer> emps) {
        Map<String, EmpEmissionsReductionClaim> sections = 
                queryEtsSection(new ArrayList<>(accountsToMigrate.keySet()));
        
        sections
            .forEach((etsAccId, section) -> 
                emps.get(accountsToMigrate.get(etsAccId).getId())
                    .getEmpContainer().getEmissionsMonitoringPlan().setEmissionsReductionClaim(section)); 
        
        // populate remaining emps with exist=false
        emps.forEach((id, emp) -> {
        	if (emp.getEmpContainer().getEmissionsMonitoringPlan().getEmissionsReductionClaim() == null) {
        		emp.getEmpContainer().getEmissionsMonitoringPlan().setEmissionsReductionClaim(
        				EmpEmissionsReductionClaim.builder().exist(false).build());
        	}
        });
    }

    @Override
    public Map<String, EmpEmissionsReductionClaim> queryEtsSection(List<String> accountIds) {
        String query = constructSectionQuery(QUERY_BASE, accountIds);

        Map<String, EmpEmissionsReductionClaim> emissionsReductionClaimMap = new HashMap<>();

        Map<String, EtsEmpEmissionsReductionClaim> emissionsReductionClaims = executeQuery(query, accountIds);
        
        for(Map.Entry<String, EtsEmpEmissionsReductionClaim> entry :emissionsReductionClaims.entrySet()) {
        	EmpEmissionsReductionClaim empEmissionsReductionClaimSection = 
        			EmpEmissionsReductionClaimMigrationMapper.toEmpEmissionsReductionClaim(entry.getValue());
        	emissionsReductionClaimMap.put(entry.getKey(), empEmissionsReductionClaimSection);
        }

        return emissionsReductionClaimMap;
    }

    private Map<String, EtsEmpEmissionsReductionClaim> executeQuery(String query, List<String> accountIds) {
    	List<EtsEmpEmissionsReductionClaim> emissionReductionClaims = migrationJdbcTemplate.query(query,
                new EtsEmpEmissionsReductionClaimRowMapper(),
                accountIds.isEmpty() ? new Object[] {} : accountIds.toArray());
        return emissionReductionClaims
            .stream()
            .collect(Collectors.toMap(EtsEmpEmissionsReductionClaim::getFldEmitterId, Function.identity()));
    }
}
